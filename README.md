# PocketLab HMH Ed Sandbox
## Deployment ##

Use my AWS sandbox account / credentials profile.

`$ cd ~/dev/pocketlab-sandbox`

`$ export AWS_PROFILE=sandbox`

Set the `PL_CODEBUILD` env var to false. This will cause utils to be installed locally.

`$ export PL_CODEBUILD=false`

Call package:zip to generate a zip archive with the lambda code files and pl-utils depedency.

`$ yarn run test`

`$ yarn run package:zip`

    Initiates a series of scripts that equate to:

    prepackage:zip
    > precompile      $ npm run clean => rm -rf ./dist
    > compile         $ tsc --outDir dist src/actions/*.ts src/domains/*.ts
                      $ npm run install:utils => bash scripts/check-env.sh
    package:zip       $ cd dist
                      $ zip -r dist.zip .
                      $ cd ..

Deployment scripts call the stack.sh bash script to package and deploy the CloudFormation templates in stacks/*.yaml using the AWS SAM CLI:

`$ yarn run package:redirect-gateway-lambdas`

`$ yarn run deploy:redirect-gateway-lambdas`

### Backend Resources ###
`arn:aws:cloudformation:us-east-1:742951340522:stack/redirect-gateway-lambdas-services-stack-dev/f438fa30-d8ad-11ed-b682-0a41fe0ace1b`

    Stack name                   : redirect-gateway-lambdas-services-stack-dev
    Region                       : us-east-1
    Confirm changeset            : False
    Deployment S3 bucket         : amplify-amplifyeval-dev-143416-deployment

## Launch Frontend App (localhost) ##

`$ yarn run serve`

## Deploy Frontend App ##

Deploying via S3 and CloudFront (required to make app available over SSL).

1. Build/generate deployment files, output directory: `dist/app-pocketlab-sandbox`:

`$ ng build --configuration=production`

2. S3: Created a new bucket for deployment (standard bucket, "static website hosting" not enabled). Enabled public access using ACL's. Uploaded deployment files with public Read access.

`https://s3.console.aws.amazon.com/s3/buckets/app-pocketlab-sandbox?region=us-east-1&tab=objects`

3. CloudFront: Created a new default Access Control (OAC) setting to allow CloudFront to sign requests for distribution with S3 origin (Security -> Access Control)

4. CloudFront: Created a new Distribution with S3 origin

Distribution Name: `https://d3gnhcbvketx3x.cloudfront.net`

Distribution ARN: `arn:aws:cloudfront::742951340522:distribution/E1QEMEJ17IHOI7`

5. S3: Added policy generated by CloudFront to S3 bucket.

6. CloudFront: Configured the access control setting I created to the distribution.

## REFERENCE ##

[Getting started with a simple CloudFront distribution](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/GettingStarted.SimpleDistribution.html)

[Restricting S3 Origin using OAC](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html)
